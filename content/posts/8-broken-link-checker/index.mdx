---
title: Broken Link Checker - znajd藕 popsute linki na stronie
date: 2021-04-26
tags:
  - npm
---

import { jsx, Link as TLink } from "theme-ui"
import Image from '../../../src/components/Image.tsx';
import ExternalPostLink from '../../../src/components/ExternalPostLink.tsx';

Z pewnoci nie chciaby, aby na twojej stronie byy niedziaajce linki lub prowadzce do strony, kt贸ra nie istnieje. W przypadku maej strony mo偶na rcznie sprawdzi, czy wszystkie linki dziaaj, ale na wikszych stronach nie bdzie to takie proste. Poza tym, jako programici powinnimy automatyzowa powtarzalne czynnoci 

<Image src="./404-error.jpeg"/>

U偶yjemy bardzo fajnej biblioteki do sprawdzania popsutych link贸w, a jest to <ExternalPostLink name="Broken Link Checker" url="https://github.com/stevenvachon/broken-link-checker"/>. 

Ostatnio w pracy miaem okazj skorzysta z tej biblioteki. Zaimplementowaem sprawdzanie wszystkich link贸w w dokumentacji naszego produktu. Ostatecznie napisany skrypt jest bardzo prosty. Najpierw dokumentacja jest budowana, nastpnie uruchamiany jest <ExternalPostLink name="http-server" url="https://github.com/http-party/http-server"/> w folderze z bundlem aplikacji, i w kocu uruchamiane jest skanowanie link贸w na tej stronie.

Bibliotek mo偶emy u偶ywa na dwa sposoby: w wierszu polece oraz w kodzie poprzez API. Zaprezentuj obie opcje.

> **Instalacja:** Musimy mie <ExternalPostLink name="zainstalowany NPM" url="https://www.npmjs.com/get-npm"/> oraz Node w wersji wiekszej lub r贸wnej 14.

### U偶ycie w wierszu polece

W celu u偶ycia biblioteki w wierszu polece, zainstalujmy j globalnie:

```shell
npm install broken-link-checker -g
```

Jeli instalacja powioda si, mo偶emy sprawdzi dostpne argumenty:
```shell
blc --help
```

Typowe u偶ycie w celu przeskanowania caej strony mo偶e wyglda nastpujco:

```shell
# -r skanuje rekurencyjnie ca stron, czyli r贸wnie偶 wszystkie podstrony
# -o zachowuje kolejno link贸w w jakiej pojawiaj si na stronie
blc https://www.oskarkowalow.pl -ro
```

Powy偶szy skrypt uruchomi skanowanie strony internetowej. Tak wyglda fragment skanowania mojej strony:

<Image src="./blc-scanning.png"/>

Wynik skanowania jest bardzo czytelny i wiadomo, kt贸re linki dziaaj, a kt贸re nie. Wida jednak, 偶e linki prowadzce do Linkedin wyrzucaj bd. To zachowanie jest nie do ominicia i linki prowadzce do Linkedin zawsze bd zwraca ten bd. 

U mnie tak wyglda wynik zakoczenia skanowania:

```
Finished! 682 links found. 578 excluded. 18 broken.
Elapsed time: 49 seconds
```

Moja strona jest jeszcze do maa i skanowanie wszystkich podstron nie byo zbyt czasochonne.

#### Pomijanie link贸w

Mo偶emy pomija skanowanie wybranych link贸w, aby przyspieszy skanowanie lub pozby si link贸w, kt贸re zawsze zwracaj bd:

- `--exclude-external` lub `-e` spowoduje pominicie wszystkich link贸w do zewntrznych serwis贸w,
- `--exclude-internal` lub `-i` spowoduje pominicie wszystkich wewntrznych link贸w, a wic bdzie sprawdza tylko zewntrzne linki,
- `--exclude` pozwala na pomijanie r贸偶nych cie偶ek i wybranych link贸w.

Tak mo偶e wyglda pominicie link贸w do Linkedin oraz podstrony "blog/kategorie":
```shell
blc https://www.oskarkowalow.pl -ro \
--exclude linkedin \
--exclude /blog/kategorie
```

#### Skanowanie tylko jednej strony

Czasem skanowanie wszystkich podstron mo偶e by bardzo czasochonne, szczeg贸lnie je偶eli mamy bardzo du偶y serwis do sprawdzenia. W takim wypadku wystarczy odj flag `-r`:

```shell
blc https://www.oskarkowalow.pl -o
```

### U偶ycie w kodzie

Biblioteka udostpnia API, dziki czemu mo偶emy u偶y jej w kodzie. Przykadowo, mo偶emy napisa skrypt w Node JS, kt贸ry bdzie sprawdza wybrane linki na stronie zanim p贸jdzie ona na produkcj. Mo偶e to by kolejny krok w ramach test贸w w naszym *Continues Integration*.

Zainstalujemy bibliotek lokalnie, wewntrz naszego projektu:
```shell
# instalujemy jako dev dependencj, gdy偶 jest potrzebna tylko podczas developmentu
npm install --save-dev broken-link-checker
```

Stw贸rzmy nowy plik w kt贸rym umiecimy cay nasz kod dotyczcy skanowania wybranego URL:

```js
// check-links.js
const { SiteChecker } = require("broken-link-checker");

const siteChecker = new SiteChecker(
  { 
    excludeInternalLinks: false,
    excludeExternalLinks: false, 
    filterLevel: 0,
    excludedKeywords: ["linkedin.com", "github.com"]
  },
  {
    "error": (error) => {
        console.error(error);
    },
    "link": (result) => {
      if (result.broken) {
        if (result.http.response && ![undefined, 200, 429].includes(result.http.response.statusCode)) {

          if (result.internal) {
            console.error(`broken internal link ${result.http.response.statusCode} => ${result.url.original}`);
          } else {
            console.warn(`broken external link ${result.http.response.statusCode} => ${result.url.original}`);
          }

        }
      }
    },
    "end": () => {
        console.log("CHECK FOR BROKEN LINKS FINISHED!");
    }
  }
);

siteChecker.enqueue("http://localhost:8000/");

```

Teraz przeledzimy sobie co dziej si w powy偶szym kodzie.

Importujemy klas `SiteChecker` i tworzymy jej now instancj z obiektem konfiguracyjnym i eventami, na kt贸re chcemy nasuchiwa. 

Chcemy skanowa linki wewntrzne, czyli nale偶ce do naszej strony (kt贸r w linii 33 bdziemy nasuchiwa, czyli wywoamy na naszym URL skanowanie) oraz linki zewntrze, czyli nie nale偶ce do naszego serwisu, np. google.com itd. 

Nastpnie wybieramy poziom <ExternalPostLink name="filtrowania" url="https://github.com/stevenvachon/broken-link-checker#filterlevel"/>, kt贸ry ustawilimy na 0, tzn., chcemy skanowa tylko tagi `a` oraz `area`, kt贸re musz zawiera atrybut `href`.

Jest kilka link贸w, kt贸rych nie chcemy skanowa, a bdzie to Linkedin (kt贸ry zawsze wyrzuci bd) oraz Github, kt贸ry prdko zacznie wyrzuca bd <ExternalPostLink name="429" url="https://developer.mozilla.org/en-US/docs/Web/HTTP/Status/429"/>. W `excludedKeywords` mo偶emy te偶 u偶ywa *glob patterns* (ale nie wszystkich) z u偶yciem biblioteki <ExternalPostLink name="matcher" url="https://www.npmjs.com/package/matcher"/>.

Nastpnie zdefiniowalimy eventy na kt贸re chcemy nasuchiwa. Jest ich sporo, ale nas najbardziej interesuj tylko trzy: `error`, `link` i `end`.

Event `link` zostanie wyemitowany za ka偶dym razem, gdy skanowanie linku zakoczy si. Wewntrz tego eventu mamy dostp do informacji o przeprowadzonym skanowaniu, w tym o sukcesie lub bdzie:

```js noLineNumbers
"link": (result) => {
  if (result.broken) {
    if (result.http.response && ![undefined, 200, 429].includes(result.http.response.statusCode)) {

      if (result.internal) {
        console.error(`broken internal link ${result.http.response.statusCode} => ${result.url.original} on page ${result.base.resolved}`);
      } else {
        console.warn(`broken external link ${result.http.response.statusCode} => ${result.url.original} on page ${result.base.resolved}`);
      }

    }
  }
},
```

W zasadzie wystarczajca mo偶e by informacja, 偶e link jest zepsuty, ale chcemy jeszcze przefiltrowa informacje sprawdzajc `statusCode`. Status `200` nigdy nie powinien si tutaj pojawi, ale `undefined` ju偶 mo偶e. Dodatkowo wykluczymy sobie status `429` o kt贸rym ju偶 wspominaem. 

Dodatkowo dla zepsutych link贸w wewntrznych chcemy u偶y `console.error`, a dla zewntrznych `console.warn`, aby zaznaczy, 偶e najwa偶niejsze dla nas s dziaajce linki wewntrzne. W logach zawieramy informacj o `statusCode`, linku kt贸ry jest zepsuty `result.url.original` oraz na stronie na kt贸rej znajduje si ten link `result.base.resolved`.

> Nie ka偶dy terminal bdzie pokazywa poprawne kolory. `console.error` i `console.warn` mog mie biay font, a nie czerwony i 偶贸ty, kt贸rych si spodziewamy. W celu zapewnienia takiego samego zachowania dla wszystkich program贸w, mo偶emy posu偶y si bibliotek <ExternalPostLink name="chalk" url="https://github.com/chalk/chalk"/>.

Event `end` zostanie wyemitowany po ostatnim przeskanowym linku.

Przykadowo, w evencie `link` mo偶emy dodawa wszystkie popsute linki do tablicy, a nastpnie w evencie `end` wywietli w konsoli cakowit ilo zepsutych link贸w wewntrznych i zewntrznych.

Teraz mo偶emy uruchomi nasz nowy plik `check-links.js`:

```shell
node check-links.js
```

### Podsumowanie

Pokazaem Ci u偶ycie biblioteki Broken Link Checker w CLI oraz w kodzie. Jak wida, jest to bardzo przydatna biblioteka. Warto od czasu do czasu sprawdzi, czy na naszej stronie wszystko dziaa, a jeszcze lepiej doda taki skrypt do naszego CI. 

Zapraszam do komentowania i dzielenia si swoimi przemyleniami 