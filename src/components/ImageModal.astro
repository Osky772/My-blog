---
export interface Props {
  id?: string;
}

const { id = 'image-modal' } = Astro.props;
---

<div id={id} class="image-modal" aria-hidden="true" role="dialog">
  <div class="modal-overlay"></div>
  <div class="modal-container">
    <button class="modal-close" aria-label="Zamknij">
      <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <line x1="18" y1="6" x2="6" y2="18"></line>
        <line x1="6" y1="6" x2="18" y2="18"></line>
      </svg>
    </button>
    <div class="modal-content">
      <img class="modal-image" alt="" />
      <div class="zoom-controls desktop-only">
        <button class="zoom-out" aria-label="Oddal">−</button>
        <span class="zoom-level">100%</span>
        <button class="zoom-in" aria-label="Przybliż">+</button>
        <button class="zoom-reset" aria-label="Resetuj">Reset</button>
      </div>
    </div>
  </div>
</div>

<style>
  .image-modal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    z-index: 9999;
  }

  .image-modal.active {
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .modal-overlay {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.9);
    backdrop-filter: blur(5px);
  }

  .modal-container {
    position: relative;
    width: 100%;
    height: 100%;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    padding: 20px;
  }

  .modal-close {
    position: fixed;
    top: 20px;
    right: 20px;
    background: rgba(0, 0, 0, 0.6);
    backdrop-filter: blur(10px);
    border: 1px solid rgba(255, 255, 255, 0.2);
    color: white;
    padding: 10px;
    border-radius: 50%;
    cursor: pointer;
    transition: all 0.2s;
    z-index: 10;
    width: 44px;
    height: 44px;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .modal-close:hover {
    background: rgba(0, 0, 0, 0.8);
    transform: scale(1.1);
  }

  .modal-content {
    position: relative;
    overflow: hidden;
    width: 100%;
    height: 100%;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .modal-image {
    max-width: 100%;
    max-height: 100%;
    width: auto;
    height: auto;
    object-fit: contain;
    transition: transform 0.3s ease;
    cursor: grab;
    user-select: none;
    -webkit-user-drag: none;
  }

  .modal-image.dragging {
    cursor: grabbing;
    transition: none;
  }

  .zoom-controls {
    position: absolute;
    bottom: 20px;
    left: 50%;
    transform: translateX(-50%);
    display: flex;
    align-items: center;
    gap: 10px;
    background: rgba(0, 0, 0, 0.8);
    padding: 8px 16px;
    border-radius: 8px;
    backdrop-filter: blur(10px);
    border: 1px solid rgba(255, 255, 255, 0.1);
  }

  .zoom-controls button {
    background: rgba(255, 255, 255, 0.1);
    color: white;
    border: 1px solid rgba(255, 255, 255, 0.2);
    padding: 6px 12px;
    border-radius: 4px;
    cursor: pointer;
    font-size: 16px;
    font-weight: 600;
    transition: all 0.2s;
  }

  .zoom-controls button:hover {
    background: rgba(255, 255, 255, 0.2);
  }

  .zoom-controls button:active {
    transform: scale(0.95);
  }

  .zoom-in, .zoom-out {
    width: 32px;
    height: 32px;
    padding: 0;
    font-size: 20px;
  }

  .zoom-level {
    color: white;
    font-size: 14px;
    min-width: 50px;
    text-align: center;
    font-weight: 500;
  }

  @media (max-width: 640px) {
    .modal-container {
      padding: 10px;
    }

    .modal-content {
      width: 100%;
      height: 100%;
    }

    .modal-close {
      top: 20px;
      right: 20px;
      background: rgba(0, 0, 0, 0.7);
      width: 40px;
      height: 40px;
    }

    .modal-image {
      max-width: 100%;
      max-height: 100%;
      width: auto;
      height: auto;
    }

    .desktop-only {
      display: none !important;
    }
  }
</style>

<script>
  class ImageModal {
    modal: HTMLElement;
    overlay: HTMLElement;
    closeBtn: HTMLElement;
    modalImage: HTMLImageElement;
    zoomInBtn: HTMLElement;
    zoomOutBtn: HTMLElement;
    zoomResetBtn: HTMLElement;
    zoomLevelDisplay: HTMLElement;
    scale: number;
    translateX: number;
    translateY: number;
    isDragging: boolean;
    startX: number;
    startY: number;
    initialDistance: number;
    initialScale: number;

    constructor(modalElement: HTMLElement) {
      this.modal = modalElement;
      this.overlay = modalElement.querySelector('.modal-overlay') as HTMLElement;
      this.closeBtn = modalElement.querySelector('.modal-close') as HTMLElement;
      this.modalImage = modalElement.querySelector('.modal-image') as HTMLImageElement;
      this.zoomInBtn = modalElement.querySelector('.zoom-in') as HTMLElement;
      this.zoomOutBtn = modalElement.querySelector('.zoom-out') as HTMLElement;
      this.zoomResetBtn = modalElement.querySelector('.zoom-reset') as HTMLElement;
      this.zoomLevelDisplay = modalElement.querySelector('.zoom-level') as HTMLElement;
      
      this.scale = 1;
      this.translateX = 0;
      this.translateY = 0;
      this.isDragging = false;
      this.startX = 0;
      this.startY = 0;
      this.initialDistance = 0;
      this.initialScale = 1;
      
      this.init();
    }

    init() {
      this.overlay.addEventListener('click', () => this.close());
      this.closeBtn.addEventListener('click', () => this.close());
      
      // Desktop only zoom controls
      if (window.innerWidth > 640) {
        this.zoomInBtn.addEventListener('click', () => this.zoom(1.25));
        this.zoomOutBtn.addEventListener('click', () => this.zoom(0.8));
        this.zoomResetBtn.addEventListener('click', () => this.resetZoom());
        
        // Wheel event for zoom on desktop
        this.modalImage.addEventListener('wheel', (e: WheelEvent) => this.handleWheel(e), { passive: false });
      }
      
      // Mouse events for desktop only
      if (window.innerWidth > 640) {
        this.modalImage.addEventListener('mousedown', (e: MouseEvent) => this.startDrag(e));
        document.addEventListener('mousemove', (e: MouseEvent) => this.drag(e));
        document.addEventListener('mouseup', () => this.endDrag());
      }
      
      // Touch events - disabled to let browser handle zoom naturally
      // Users can use native browser pinch zoom on mobile
      
      // Keyboard shortcuts
      document.addEventListener('keydown', (e: KeyboardEvent) => {
        if (!this.modal.classList.contains('active')) return;
        
        if (e.key === 'Escape') this.close();
        if (e.key === '+' || e.key === '=') this.zoom(1.25);
        if (e.key === '-' || e.key === '_') this.zoom(0.8);
        if (e.key === '0') this.resetZoom();
      });
    }

    open(imageSrc: string) {
      this.modal.classList.add('active');
      this.modalImage.src = imageSrc;
      this.resetZoom();
      document.body.style.overflow = 'hidden';
    }

    close() {
      this.modal.classList.remove('active');
      document.body.style.overflow = '';
      this.resetZoom();
    }

    zoom(factor: number) {
      const newScale = this.scale * factor;
      if (newScale >= 1 && newScale <= 5) {
        this.scale = newScale;
        this.updateTransform();
      }
    }

    resetZoom() {
      this.scale = 1;
      this.translateX = 0;
      this.translateY = 0;
      this.updateTransform();
    }

    updateTransform() {
      this.modalImage.style.transform = `translate(${this.translateX}px, ${this.translateY}px) scale(${this.scale})`;
      if (this.zoomLevelDisplay) {
        this.zoomLevelDisplay.textContent = `${Math.round(this.scale * 100)}%`;
      }
    }

    startDrag(e: MouseEvent) {
      if (this.scale <= 1) return;
      
      this.isDragging = true;
      this.modalImage.classList.add('dragging');
      this.startX = e.clientX - this.translateX;
      this.startY = e.clientY - this.translateY;
      e.preventDefault();
    }

    drag(e: MouseEvent) {
      if (!this.isDragging) return;
      
      this.translateX = e.clientX - this.startX;
      this.translateY = e.clientY - this.startY;
      this.updateTransform();
    }

    endDrag() {
      this.isDragging = false;
      this.modalImage.classList.remove('dragging');
    }

    handleTouchStart(e: TouchEvent) {
      // Disable all touch interactions on mobile
      // Let the browser handle pinch zoom naturally
      return;
    }

    handleTouchMove(e: TouchEvent) {
      // Disable all touch interactions on mobile
      return;
    }

    handleTouchEnd(e: TouchEvent) {
      // Disable all touch interactions on mobile
      return;
    }

    handleWheel(e: WheelEvent) {
      e.preventDefault();
      
      const delta = e.deltaY > 0 ? 0.9 : 1.1;
      const newScale = this.scale * delta;
      
      if (newScale >= 1 && newScale <= 5) {
        // Calculate zoom point
        const rect = this.modalImage.getBoundingClientRect();
        const x = e.clientX - rect.left - rect.width / 2;
        const y = e.clientY - rect.top - rect.height / 2;
        
        // Adjust translation to zoom towards cursor
        this.translateX = this.translateX * delta - x * (delta - 1);
        this.translateY = this.translateY * delta - y * (delta - 1);
        this.scale = newScale;
        
        this.updateTransform();
      }
    }
  }

  // Initialize modal when DOM is ready
  document.addEventListener('DOMContentLoaded', () => {
    const modalElement = document.getElementById('image-modal');
    if (modalElement) {
      const modal = new ImageModal(modalElement);
      
      // Attach click handlers to all images in posts
      document.querySelectorAll('.post-content img').forEach((img: Element) => {
        const image = img as HTMLImageElement;
        image.style.cursor = 'pointer';
        image.addEventListener('click', () => {
          modal.open(image.src);
        });
      });
    }
  });
</script>